js_import conf.d/sablier.js;

# internal docker resolver, see /etc/resolv.conf on proxy container
resolver 127.0.0.11 valid=10s ipv6=off;

server {
  listen 80;

  subrequest_output_buffer_size 32k;

  set $sablierUrl /sablier;
  set $sablierSessionDuration 1m;

  location @whoami {
    # Use variable in order to refresh DNS cache
    set $whoami_server whoami;
    proxy_pass http://$whoami_server:80;
    proxy_set_header Host localhost:8080; # e2e test compliance
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location @nginx {
    # Use variable in order to refresh DNS cache
    set $nginx_server nginx;
    proxy_pass http://$nginx_server:80;
    proxy_set_header Host localhost:8080; # e2e test compliance
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /sablier/ {
    internal;
    proxy_method GET;
    proxy_pass http://sablier:10000/;
  }

  location /dynamic/whoami {
    set $sablierDynamicShowDetails true;
    set $sablierDynamicRefreshFrequency 5s;
    set $sablierNginxInternalRedirect @whoami;
    set $sablierNames DOCKER_SWARM_E2E_whoami;
    set $sablierDynamicName "Dynamic Whoami";
    set $sablierDynamicTheme hacker-terminal;
    js_content sablier.call;
  }

  location /blocking/whoami {
    set $sablierNginxInternalRedirect @whoami;
    set $sablierNames DOCKER_SWARM_E2E_whoami;
    set $sablierBlockingTimeout 30s;
    js_content sablier.call;
  }

  location /multiple/nginx {
    set $sablierDynamicShowDetails true;
    set $sablierDynamicRefreshFrequency 5s;
    set $sablierNginxInternalRedirect @nginx;
    set $sablierNames DOCKER_SWARM_E2E_nginx,DOCKER_SWARM_E2E_whoami;
    set $sablierDynamicName "Multiple Whoami";
    set $sablierDynamicTheme hacker-terminal;
    js_content sablier.call;
  }

  location /multiple/whoami {
    set $sablierDynamicShowDetails true;
    set $sablierDynamicRefreshFrequency 5s;
    set $sablierNginxInternalRedirect @whoami;
    set $sablierNames DOCKER_SWARM_E2E_nginx,DOCKER_SWARM_E2E_whoami;
    set $sablierDynamicName "Multiple Whoami";
    set $sablierDynamicTheme hacker-terminal;
    js_content sablier.call;
  }

  location /healthy/nginx {
    set $sablierDynamicShowDetails true;
    set $sablierDynamicRefreshFrequency 5s;
    set $sablierNginxInternalRedirect @nginx;
    set $sablierNames DOCKER_SWARM_E2E_nginx;
    set $sablierDynamicName "Healthy Nginx";
    set $sablierDynamicTheme hacker-terminal;
    js_content sablier.call;
  }
}